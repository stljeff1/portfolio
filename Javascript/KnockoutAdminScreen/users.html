<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Admin Screen w/ Knockout</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="./admin-styles.css"/>
</head>
<body>

	<div class='container'>
		<div class="row">
			<div class="col-sm-4">
				<h2>Manage Users</h2>
				<p>Use this page to change details of each user.</p>
				<div class="user-list">
					<ul data-bind="foreach: users" class="user-list list-group">
						<li class="list-group-item" data-bind="css: {'active': id() == $parent.userEditor.user().id()}">
							<div class="media" data-bind="click: $parent.toggleUser">
								<div class="media-left">
									<img data-bind="attr: {'src': img}" src="http://www.wallstreetotc.com/wp-content/uploads/2014/10/facebook-anonymous-app.jpg"/>
								</div>
								<div class="media-body">
									<h4 class="media-heading" data-bind="text: name"></h4>
								</div>
							</div>
						</li>
					</ul>
				</div>
			</div>

			<div class="col-sm-8">
				<h2>Edit User Details</h2>
				<div class="user-details" data-bind="with: userEditor">
					<form class="form-horizontal">
				

						<edit-inline params="value: user().name, labelText: 'Name'"></edit-inline>
						<edit-inline params="value: user().email, labelText: 'Email'"></edit-inline>


						<div class=" form-group"> 
							<label class="control-label col-sm-3"> Favorite Teams:</label>
							<div class="col-sm-9">
								<div class="" data-bind="visible: user().favTeams().length === 0">
									<em>No favorite teams.</em>
								</div>
								<div class="sortable list-group" data-bind="sortable: {foreach: user().favTeams, as: 'team'} ">

									
								    	<div class="draggable-item list-group-item">
								    	<span class="pull-right" data-bind="click: $parent.removeTeam"><i class="glyphicon glyphicon-remove"></i></span>
								    		<span data-bind="text: ($index()+1) + '. ' + team.name"></span>
								    	</div>
								</div>

								<script type="text/html" id="sortable-item">
								</script>
							</div>
						</div>


						<div class="form-group"> 
							<label class="control-label col-sm-3">Add Team:</label>
							<div class="col-sm-9">
									
								<add-to-list params="list: $root.filteredTeams(), optionsText: 'name', submit: addTeam, disable: (user().favTeams().length >= 5), limitMsg: 'Stop it! you have enough favorite teams.'">
								</add-to-list>
							</div>
						</div>



						<hr/>
						<a href="#" class="btn btn-primary" data-bind="css: { disabled: (isClean() == -1 || isClean() !== false) }, click: $root.saveUser">Save Changes</a>
						<a href="#" class="btn btn-warning" data-bind="css: { disabled: (isClean() == -1 || isClean() !== false)  }, click: resetUser">Cancel changes</a>
						<br/>
						<div class="json-output" style="display: none;">
							<h5>JSON to Server</h5>
							<pre></pre>
						</div>
					</form>
				</div>
				<section class="log-table">
					<h4>Server Acticvity Log</h4>
										<table class="table table-striped" data-bind="visible: log().length">
							<tr>
								<th width="35%">Action</th>
								<th>Message</th>
							</tr>
							<tbody data-bind="foreach: log">
								<tr>
									<td data-bind="text: action"></td>
									<td data-bind="html: message"></td>
								</tr>
							</tbody>


						</table>
				</section>


			</div>
		</div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-debug.js"></script>
	<script type="text/javascript" src="./Sortable.js"></script>
	<script type="text/javascript" src="./knockout-sortable.js"></script>

	<script type="text/javascript" src="../edit-inline-knockout-component/edit-inline-component.js"></script>
	<script type="text/javascript" src="../add-to-list-knockout-component/add-to-list-component.js"></script>


	<script type="text/javascript">
		


		(function($, ko) {

			var myUsers = [{
				id: 131,
				name: 'Steve',
				email: 'steve@corporate.com',
				img: 'http://gokubi.com/wp-content/uploads/2013/10/Steve-Andersen-Headshot-square1.jpeg',
				favTeams: [
					{"ID": "139", "name": "Tampa Bay Rays" },
					{"ID": "133", "name": "Oakland Athletics" },
					{"ID": "109", "name": "Arizona Diamondbacks"}
				]
			}, {
				id: 244,
				name: 'Kim',
				email: 'kim@corporate.com',
				img: 'http://notebookingfairy.com/wp-content/uploads/2012/10/jimmie-headshot-square-9-2016-300x300.jpg',
				favTeams: [
					{"ID": "111", "name": "Boston Red Sox" }
				]
			}, {
				id: 331,
				name: 'Manoj',
				email: 'manoj@corporate.com',
				img: 'http://foundershield.com/wp-content/uploads/2017/03/Manoj-Headshot-square-200x200.jpg',
				favTeams: [
					{"ID": "120", "name": "Washington Nationals" },
					{"ID": "110", "name": "Baltimore Orioles" },
					{"ID": "136", "name": "Seattle Mariners"}
				]
			}, {
				id: 421,
				name: 'Brian',
				email: 'dan@corporate.com',
				img: 'https://aikenareaprogressive.files.wordpress.com/2016/12/steven-long-headshot-square-250x250.jpg?w=500',
				favTeams: [
					{"ID": "138", "name": "St. Louis Cardinals" }
				]
			}];


			ko.dirtyFlag = function(root, isInitiallyDirty) {
			    var result = function() {},
			        _initialState = ko.observable(ko.toJSON(root)),
			        _isInitiallyDirty = ko.observable((isInitiallyDirty) ? true : false);

			    result.isDirty = ko.computed(function() {
			    		var isDirty = _isInitiallyDirty();
			    		if(isDirty) 
			    			return true;
			    		else {
			    			console.log('is this dirty?', _initialState(), ko.toJSON(root), root, (_initialState() !== ko.toJSON(root)));
			    			_initialState() !== ko.toJSON(root);
			    		}
			    });

			    result.reset = function() {
			        _initialState(ko.toJSON(root));
			        _isInitiallyDirty(false);
			    };

			    return result;
			};

			function Team(teamID, teamName) {
				this.ID = teamID;
				this.name = teamName;
			}

			function User(userObj) {
				var self = this;

				self.id = ko.observable(userObj.id || '');

				self.name = ko.observable(userObj.name || '');
				self.email = ko.observable(userObj.email || '');
				self.favTeams = ko.observableArray(userObj.favTeams || []);

				self.img = userObj.img;


    				//self.dirtyFlag = new ko.dirtyFlag(self);
    				self.update = function(newValue) {
    					self.id(newValue.id)
    					self.name(newValue.name);
    					self.email(newValue.email);
    					self.favTeams(newValue.favTeams);
    				}
			}

			function EditUser(user) {

				var self = this;
				var origValue = null;
				var onDataChange = function(dirtyUser) {
					var cleanUser = ko.toJSON(self.origUser);
					self.isClean((dirtyUser === cleanUser));
					console.log('user change', dirtyUser, cleanUser, self.isClean());
				}

				self.user = ko.observable(new User({}));
				self.origUser = ko.observable(user);

				self.isClean = ko.observable(-1);


				self.addTeam = function(team) {
					console.log('adding team: ', team);
					self.user().favTeams.push(team);
				};

				self.removeTeam = function(obj) {
					//var index = self.favTeams.indexOf(obj);
					self.user().favTeams.remove(obj);
				};


				self.initUser = function(userObj) {
					var origValue = ko.toJS(userObj);
					self.origUser(userObj);

					self.user(new User(origValue));
					console.log('init user',userObj, self.user(), self.origUser());
					
					self.userData = ko.computed(function() {
						return ko.toJSON(self.user);
					}).subscribe(onDataChange);
					self.isClean(true);
				};

				self.saveUser = function() {
					console.log('saving????????', self.origUser());
					var newValue = ko.toJS(self.user);

					var json = ko.toJSON(newValue, null, 4);

					self.origUser().update(newValue);

					console.log('saving????????', self.origUser(), json);

					$('.json-output').show().find('pre').html(syntaxHighlight(json));
				};

				self.resetUser = function() {
					var origValue = ko.toJS(self.origUser);
					console.log(origValue);
					self.user().update(origValue);
					//self.isClean(false);
				}

				self.echoUser = function() {


				}

			}
			function ManageUsers() {
				var self = this;

				self.users = ko.observableArray([]);

				self.mlbTeams = ko.observableArray([]);

				self.selectedUser = ko.observable();

				self.userEditor = new EditUser();

				self.log = ko.observableArray([]);



				self.filteredTeams = function() {
					console.log(self.selectedUser(), self.mlbTeams());
					if(!self.selectedUser())
						return self.mlbTeams();
					else {
						return ko.utils.arrayFilter(self.mlbTeams(), function(team) {
							var match = -1;
							ko.utils.arrayForEach(self.selectedUser().favTeams(), function(t) {
								if(typeof t == 'string') {
									if(t == team.ID)
										match = 1;
								}
								else {

									if(t.ID == team.ID)
										match = 1;

								}
							});
								return match <= 0;
						});
					}


				};

				self.loadTeams = function(callback) {
					$.ajax({
						//url: 'http://mlb.com/lookup/json/named.team_all.bam',
						url: 'http://mlb.com/lookup/json/named.team_all.bam?sport_code=%27mlb%27&active_sw=%27Y%27&all_star_sw=%27N%27',
						/*data: {
							'sport_code': 'mlb',
							'active_sw': 'Y',
							'all_star_sw': 'N'

						}*/
						success: function(data) {
							console.log(data);
							var teams = data.team_all.queryResults.row;
							var count = teams.length;
							self.log.push({action: 'Loaded Team List', message: 'Count: ' + count});
							teams.forEach(function(team) {
								self.mlbTeams.push(new Team(team.team_id, team.name_display_long));
								if(self.mlbTeams().length == count) 
									callback();

							});

						}
					});
				};

				self.saveUser = function() {
					var user = self.userEditor.user;
					self.log.push({action: 'Save User', message: syntaxHighlight(ko.toJSON(user))});
					self.userEditor.initUser(user());
					
				}

				self.loadUsers = function(userList) {

					userList.forEach(function(user) {
						self.users.push(new User(user));
					});

				};

				self.initDisplay = function() {
					console.log('initDisplay', self.mlbTeams());
					self.userEditor.initUser(self.users()[0]);
				};

				self.toggleUser = function() {
					console.log('toggleUser', arguments, this);
					self.userEditor.initUser(this);
				}
			}

			$(function() {

				var vm = new ManageUsers();

				vm.loadUsers(myUsers);

				vm.loadTeams(function() {
					ko.applyBindings(vm);
					vm.initDisplay();
				})



			});


			function syntaxHighlight(json) {
			    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
			    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
			        var cls = 'number';
			        if (/^"/.test(match)) {
			            if (/:$/.test(match)) {
			                cls = 'key';
			            } else {
			                cls = 'string';
			            }
			        } else if (/true|false/.test(match)) {
			            cls = 'boolean';
			        } else if (/null/.test(match)) {
			            cls = 'null';
			        }
			        return '<span class="' + cls + '">' + match + '</span>';
			    });
			}

		})(jQuery, ko);

	</script>
</body>
</html>